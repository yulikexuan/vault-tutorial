# VAULT Tutorial

## Basic Key/Value Operation

### Start a dev server
  - ``` vault server -dev ```

### Start a vault client session

  - Connect to vault server
    - ``` export VAULT_ADDR='http://127.0.0.1:8200' ``` 
    - ``` set VAULT_ADDR=http://127.0.0.1:8200 ```

  - Save Key and Token
    - Unseal Key: VLAmNXfWlwCobgJyY70MgVS3X0WtRL4+DiLanj5qcIc=
    - Root Token: s.7jzhwqKfPN3oO2ERyTiXoQaa

  - Setup Token
    - ``` export VAULT_TOKEN="s.7jzhwqKfPN3oO2ERyTiXoQaa" ``` 
    - ``` set VAULT_TOKEN=s.7jzhwqKfPN3oO2ERyTiXoQaa ``` 

  - Validate vault server
    - ``` vault status ```

### Put keys

  - ``` vault kv put secret/hello username=yul pw=123456 ```

### Get keys back

  - ``` vault kv get secret/hello ``` 
  - ``` vault kv get -format=json secret/hello ``` 
  - ``` vault kv get -format=json secret/hello | jq > secret.hello.json ``` 

### Delete keys

  - ``` vault kv delete secret/hello ```

## The Concept of Secret Engine 

### Add a New Path to a Secret Engine

  - ``` vault secrets enable -path=kv kv ```
    - Success! Enabled the kv secrets engine at: kv/

### List all secrets

  - ``` vault secrets list ```

### Disable a secret path

  - ``` vault secrets disable kv/ ```


## [Token Authentication](https://learn.hashicorp.com/tutorials/vault/getting-started-authentication?in=vault/getting-started)
- How users can authenticate with Vault tokens and the GitHub authentication method

### To Create a New Token

- ``` vault token create ```

### Login with the new Token

- ``` vault login s.iyNUhq8Ov4hIAx6snw5mB2nL ```

### To Revoke a Token

- ``` vault token revoke s.iyNUhq8Ov4hIAx6snw5mB2nL ```

### Enable the GitHub Auth Method

- ``` vault auth enable github ```

### Set the Organization for the github Authentication

- ``` vault write auth/github/config organization=yul-itopia ```

### Configure the GitHub "itopia" team authentication 

- To be granted the default and applications policies

  ``` vault write auth/github/map/teams/itopia value=default,applications ```

    - The members of the GitHub "itopia" team in the "yul-itopia" organization 
      will authenticate and are authorized with the default and applications 
      policies 

### Display all the Authentication Methods that Vault has Enabled

- ``` vault auth list ```

  - To learn more about the github auth method using help
    ``` vault auth help github ```

### Attempt to login with the github Auth Method

- ``` vault login -method=github ```

### Revoke all Tokens generated the github Auth Method

- ``` vault token revoke -mode path auth/github ```

  - All tokens generated by logins to the path auth/github are revoked

### Disable the github Auth Method

  - All authentication methods, except for the token auth method, can be disabled

  ``` vault auth disable github ```


## [Policies and Authorization](https://learn.hashicorp.com/tutorials/vault/getting-started-policies?in=vault/getting-started)

### To View the Default Policy

- ``` vault policy read default ```

### To Write a Policy

- ``` vault policy write yul-policy yul-policy.hcl ```

### To List all Policies

- ``` vault policy list ```

### To View the Contents of the Policy Defined

- ``` vault policy read yul-policy ```

### To Test the Policy Defined

- Create a token and add yul-policy to it
  
    ``` vault token create -policy=yul-policy ```

- Write a secret to the path "secret/data/creds"
  - NOTE: When access a KV v2 secrets engine using the vault kv CLI commands, 
    you can omit /data in the secret path.
    - ``` VAULT_TOKEN=s.As7wnnbIS0i0MFvf7L3bNjqG vault kv put secret/creds pw=123456 ```

  - Attempt to write to the secret/data/foo path
    - ``` VAULT_TOKEN=s.As7wnnbIS0i0MFvf7L3bNjqG valut kv put secret/foo pw=888888 ```

    
### Associate Policies to Auth Methods

- Check to verify that approle auth method has not been enabled at the path 
  approle/
  
  ``` vault auth list | grep 'approle/' ```

- If this command produces no output (i.e. approle/ is not listed), enable it 
  before proceeding
  
  ``` vault auth enable approle ```

  - Now, enable an AppRole role "my-role", to configure some basic token option 
  - Attach the previously defined "yul-policy" policy to all tokens that it 
    creates when applications authenticate with the role
    
    ``` 
        $ vault write auth/approle/role/dev-role \
        > secret_id_ttl=10m \
        > token_num_uses=10 \
        > token_ttl=20m \
        > token_max_ttl=30m \
        > secret_id_num_uses=40 \
        > token_policies=yul-policy
        Success! Data written to: auth/approle/role/dev-role
    ```

- To authenticate with AppRole, first fetch the role ID, and capture its value 
  in a ROLE_ID environment variable 
  
  ``` export ROLE_ID="$(vault read -field=role_id auth/approle/role/dev-role/role-id)" ```

- Get a secret ID (which is similar to a password for applications to use for 
  AppRole authentication), and capture its value in the SECRET_ID environment 
  variable
  
  ``` export SECRET_ID="$(vault write -f -field=secret_id auth/approle/role/my-role/secret-id)" ```
- Finally, authenticate to AppRole with vault write by specifying the role path 
  and passing the role ID and secret ID values with the respective options 
  
 ``` vault write auth/approle/login role_id="$ROLE_ID" secret_id="$SECRET_ID" ```
 
    ``` 
    $ vault write auth/approle/login role_id="$ROLE_ID" secret_id="$SECRET_ID"
    Key                     Value
    ---                     -----
    token                   s.YHReLvH4EpsyvX9GsB01iAst
    token_accessor          hPbUebVv70PPoDIgej3MAyOJ
    token_duration          20m
    token_renewable         true
    token_policies          ["default" "yul-policy"]
    identity_policies       []
    policies                ["default" "yul-policy"]
    token_meta_role_name    dev-role
    ```

## [Deploy Vault](https://learn.hashicorp.com/tutorials/vault/getting-started-deploy?in=vault/getting-started)

- How to configure Vault, start Vault, use the seal/unseal process, and scale Vault

### Configuring Vault

- Also check [Configure Vault](https://learn.hashicorp.com/tutorials/vault/configure-vault)

- Vault is configured using HCL files. The configuration file for Vault is 
  relatively simple
  
  ``` 
    storage "raft" {
    path    = "./vault/data"
    node_id = "node1"
    }
    
    listener "tcp" {
    address     = "127.0.0.1:8200"
    tls_disable = 1
    }
    
    api_addr = "http://127.0.0.1:8200"
    cluster_addr = "https://127.0.0.1:8201"
    ui = true
  ```
  
- Within the configuration file, there are two primary configurations

  1. storage - This is the physical backend that Vault uses for storage
     - Up to this point the dev server has used "inmem" (in memory), 
       but the example above uses integrated storage (raft), 
       a much more production-ready backend
  2. listener - One or more listeners determine how Vault listens for API 
     requests
     - The example above listens on localhost port 8200 without TLS
       In your environment set VAULT_ADDR=http://127.0.0.1:8200 so the Vault 
       client will connect without TLS

- ``` api_addr ``` - Specifies the address to advertise to route client requests
- ``` cluster_addr ``` - Indicates the address and port to be used for 
  communication between the Vault nodes in a cluster

### Starting the Server

- The /vault/data directory that raft storage backend uses must exist
  ``` mkdir -p vault/data ```

- Set the -config flag to point to the proper path where you saved the 
  configuration above
  ``` vault server -config=config.hcl ```
  - NOTE: If you get a warning message about ``` mlock``` not being supported, 
    that is okay. However, for maximum security you should run Vault on a 
    system that supports ``` mlock```

### Initializing the Vault

- Launch a new terminal session, and set VAULT_ADDR environment variable
  ``` export VAULT_ADDR='http://127.0.0.1:8200' ```
  
- To initialize Vault use vault operator init
  - This is an unauthenticated request, but it only works on a brand-new Vaults 
    without existing data:
    ``` vault operator init ```
    ``` 
    $ vault operator init
    Unseal Key 1: <KEY_1>
    Unseal Key 2: <KEY_2>
    Unseal Key 3: <KEY_3>
    Unseal Key 4: <KEY_4>
    Unseal Key 5: <KEY_5>
    
    Initial Root Token: <TOKEN>
    
    Vault initialized with 5 key shares and a key threshold of 3. Please securely
    distribute the key shares printed above. When the Vault is re-sealed,
    restarted, or stopped, you must supply at least 3 of these keys to unseal it
    before it can start servicing requests.
    
    Vault does not store the generated master key. Without at least 3 key to
    reconstruct the master key, Vault will remain permanently sealed!
    
    It is possible to generate new unseal keys, provided you have a quorum of
    existing unseal keys shares. See "vault operator rekey" for more information.
    ```

### Seal / Unseal

- Begin unsealing the Vault

  ``` vault operator unseal ```

  ``` 
    $ vault operator unseal <KEY_1>
    Key                Value
    ---                -----
    Seal Type          shamir
    Initialized        true
    Sealed             true
    Total Shares       5
    Threshold          3
    Unseal Progress    1/3
    Unseal Nonce       4084ab9c-2a32-58c6-3945-cfc042827d00
    Version            1.6.1
    Storage Type       raft
    HA Enabled         true
    
    yul@YuLi10 MINGW64 /c/TecsysDev/javaguru/projects/vault-space/vault-tutorial (main)
    $ vault operator unseal <KEY_5>
    Key                Value
    ---                -----
    Seal Type          shamir
    Initialized        true
    Sealed             true
    Total Shares       5
    Threshold          3
    Unseal Progress    2/3
    Unseal Nonce       4084ab9c-2a32-58c6-3945-cfc042827d00
    Version            1.6.1
    Storage Type       raft
    HA Enabled         true
    
    yul@YuLi10 MINGW64 /c/TecsysDev/javaguru/projects/vault-space/vault-tutorial (main)
    $ vault operator unseal <KEY_3>
    Key                     Value
    ---                     -----
    Seal Type               shamir
    Initialized             true
    Sealed                  false
    Total Shares            5
    Threshold               3
    Version                 1.6.1
    Storage Type            raft
    Cluster Name            vault-cluster-853f2a97
    Cluster ID              b4428af6-9aef-9fc2-4c47-f93dc37db7eb
    HA Enabled              true
    HA Cluster              n/a
    HA Mode                 standby
    Active Node Address     <none>
    Raft Committed Index    24
    Raft Applied Index      24
  ```
  
  - When the value for Sealed changes to false, the Vault is unsealed

### Finally, authenticate as the initial root token

  ``` vault login <TOKEN> ```

### Reseal

  ``` vault operator seal ```
  - This lets a single operator lock down the Vault in an emergency without 
    consulting other operators
  - When the Vault is sealed again, it clears all of its state (including the 
    encryption key) from memory. The Vault is secure and locked down from access

### Clean up

- To kill the Vault process from a command
  ``` ps aux | grep "vault server" | grep -v grep | awk '{print $2}' | xargs kill ```

- Delete the /vault/data directory which stores the encrypted Vault data
  ``` rm -r vault/data  ```