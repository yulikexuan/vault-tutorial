# VAULT Tutorial

## Basic Key/Value Operation

### Start a dev server
  - ``` vault server -dev ```

### Start a vault client session

  - Connect to vault server
    - ``` export VAULT_ADDR='http://127.0.0.1:8200' ``` 
    - ``` set VAULT_ADDR=http://127.0.0.1:8200 ```

  - Save Key and Token
    - Unseal Key: VLAmNXfWlwCobgJyY70MgVS3X0WtRL4+DiLanj5qcIc=
    - Root Token: s.7jzhwqKfPN3oO2ERyTiXoQaa

  - Setup Token
    - ``` export VAULT_TOKEN="s.7jzhwqKfPN3oO2ERyTiXoQaa" ``` 
    - ``` set VAULT_TOKEN=s.7jzhwqKfPN3oO2ERyTiXoQaa ``` 

  - Validate vault server
    - ``` vault status ```

### Put keys

  - ``` vault kv put secret/hello username=yul pw=123456 ```

### Get keys back

  - ``` vault kv get secret/hello ``` 
  - ``` vault kv get -format=json secret/hello ``` 
  - ``` vault kv get -format=json secret/hello | jq > secret.hello.json ``` 

### Delete keys

  - ``` vault kv delete secret/hello ```

## The Concept of Secret Engine 

### Add a New Path to a Secret Engine

  - ``` vault secrets enable -path=kv kv ```
    - Success! Enabled the kv secrets engine at: kv/

### List all secrets

  - ``` vault secrets list ```

### Disable a secret path

  - ``` vault secrets disable kv/ ```


## [Token Authentication](https://learn.hashicorp.com/tutorials/vault/getting-started-authentication?in=vault/getting-started)
- How users can authenticate with Vault tokens and the GitHub authentication method

### To Create a New Token

- ``` vault token create ```

### Login with the new Token

- ``` vault login s.iyNUhq8Ov4hIAx6snw5mB2nL ```

### To Revoke a Token

- ``` vault token revoke s.iyNUhq8Ov4hIAx6snw5mB2nL ```

### Enable the GitHub Auth Method

- ``` vault auth enable github ```

### Set the Organization for the github Authentication

- ``` vault write auth/github/config organization=yul-itopia ```

### Configure the GitHub "itopia" team authentication 

- To be granted the default and applications policies

  ``` vault write auth/github/map/teams/itopia value=default,applications ```

    - The members of the GitHub "itopia" team in the "yul-itopia" organization 
      will authenticate and are authorized with the default and applications 
      policies 

### Display all the Authentication Methods that Vault has Enabled

- ``` vault auth list ```

  - To learn more about the github auth method using help
    ``` vault auth help github ```

### Attempt to login with the github Auth Method

- ``` vault login -method=github ```

### Revoke all Tokens generated the github Auth Method

- ``` vault token revoke -mode path auth/github ```

  - All tokens generated by logins to the path auth/github are revoked

### Disable the github Auth Method

  - All authentication methods, except for the token auth method, can be disabled

  ``` vault auth disable github ```


## [Policies and Authorization](https://learn.hashicorp.com/tutorials/vault/getting-started-policies?in=vault/getting-started)

### To View the Default Policy

- ``` vault policy read default ```

### To Write a Policy

- ``` vault policy write yul-policy yul-policy.hcl ```

### To List all Policies

- ``` vault policy list ```

### To View the Contents of the Policy Defined

- ``` vault policy read yul-policy ```

### To Test the Policy Defined

- Create a token and add yul-policy to it
  
    ``` vault token create -policy=yul-policy ```

- Write a secret to the path "secret/data/creds"
  - NOTE: When access a KV v2 secrets engine using the vault kv CLI commands, 
    you can omit /data in the secret path.
    - ``` VAULT_TOKEN=s.As7wnnbIS0i0MFvf7L3bNjqG vault kv put secret/creds pw=123456 ```

  - Attempt to write to the secret/data/foo path
    - ``` VAULT_TOKEN=s.As7wnnbIS0i0MFvf7L3bNjqG valut kv put secret/foo pw=888888 ```

    
### Associate Policies to Auth Methods

- Check to verify that approle auth method has not been enabled at the path 
  approle/
  
  ``` vault auth list | grep 'approle/' ```

- If this command produces no output (i.e. approle/ is not listed), enable it 
  before proceeding
  
  ``` vault auth enable approle ```

  - Now, enable an AppRole role "my-role", to configure some basic token option 
  - Attach the previously defined "yul-policy" policy to all tokens that it 
    creates when applications authenticate with the role
    
    ``` 
        $ vault write auth/approle/role/dev-role \
        > secret_id_ttl=10m \
        > token_num_uses=10 \
        > token_ttl=20m \
        > token_max_ttl=30m \
        > secret_id_num_uses=40 \
        > token_policies=yul-policy
        Success! Data written to: auth/approle/role/dev-role
    ```

- To authenticate with AppRole, first fetch the role ID, and capture its value 
  in a ROLE_ID environment variable 
  
  ``` export ROLE_ID="$(vault read -field=role_id auth/approle/role/dev-role/role-id)" ```

- Get a secret ID (which is similar to a password for applications to use for 
  AppRole authentication), and capture its value in the SECRET_ID environment 
  variable
  
  ``` export SECRET_ID="$(vault write -f -field=secret_id auth/approle/role/my-role/secret-id)" ```
- Finally, authenticate to AppRole with vault write by specifying the role path 
  and passing the role ID and secret ID values with the respective options 
  
 ``` vault write auth/approle/login role_id="$ROLE_ID" secret_id="$SECRET_ID" ```
 
    ``` 
    $ vault write auth/approle/login role_id="$ROLE_ID" secret_id="$SECRET_ID"
    Key                     Value
    ---                     -----
    token                   s.YHReLvH4EpsyvX9GsB01iAst
    token_accessor          hPbUebVv70PPoDIgej3MAyOJ
    token_duration          20m
    token_renewable         true
    token_policies          ["default" "yul-policy"]
    identity_policies       []
    policies                ["default" "yul-policy"]
    token_meta_role_name    dev-role
    ```